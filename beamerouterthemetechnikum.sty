% Beamer Outer Theme Technikum
% Defines outer elements: headers, footers, sidebars
\ProvidesPackage{beamerouterthemetechnikum}[2025/11/03 Technikum Outer Theme]

\mode<presentation>

% =============================================================================
% FOOTNOTE POSITIONING
% =============================================================================
% Ensure footnotes appear above navigation symbols and footline
% The key is setting appropriate vertical spacing and beamer depth
\setbeamertemplate{footnote}{%
    \parindent 1em\noindent%
    \raggedright
    \hbox to 1.8em{\hfil\insertfootnotemark}\insertfootnotetext\par%
}

% Position footnote above footline by adjusting vertical space
% This ensures footnotes don't overlap with navigation or footer elements
\addtobeamertemplate{footnote}{}{\vspace{2ex}}

% =============================================================================
% NAVIGATION SYMBOLS
% =============================================================================
% Control navigation symbols based on theme option
\ifbeamer@technikum@navigation
    % Keep default navigation symbols
\else
    % Hide navigation symbols
    \setbeamertemplate{navigation symbols}{}
\fi

% =============================================================================
% FRAMETITLE
% =============================================================================
\newsavebox{\beamer@technikum@logobox}
\newlength{\beamer@technikum@frametitlelogowidth}
\newlength{\beamer@technikum@frametitlewidth}

\ifbeamer@technikum@frametitle
    \setbeamertemplate{frametitle}{%
        \nointerlineskip%
        % Measure logo and calculate title width
        \setlength{\beamer@technikum@frametitlelogowidth}{0pt}%
        \ifbeamer@technikum@frametitlelogo
            \sbox{\beamer@technikum@logobox}{\includegraphics[height=\beamer@technikum@logoheight]{assets/images/logo.pdf}}%
            \setlength{\beamer@technikum@frametitlelogowidth}{\wd\beamer@technikum@logobox}%
        \fi
        \setlength{\beamer@technikum@frametitlewidth}{\dimexpr\paperwidth-0.6cm\relax}%
        \ifdim\beamer@technikum@frametitlelogowidth>0pt
            \addtolength{\beamer@technikum@frametitlewidth}{-\beamer@technikum@frametitlelogowidth}%
            \addtolength{\beamer@technikum@frametitlewidth}{-0.3cm}% Padding
        \fi

        \begin{tikzpicture}[trim left=\beamer@leftmargin, trim right=\dimexpr\paperwidth-\beamer@rightmargin\relax]
            % Get colors from beamer color scheme
            \usebeamercolor{frametitle}
            \usebeamercolor{framesubtitle}

            % Define style for background node
            \tikzset{
                frametitle background/.style={
                        fill=frametitle.bg,
                        draw=none,
                    }
            }

            % Define style for text node
            \tikzset{
                frametitle node/.style={
                        anchor=north west,
                        text width=\beamer@technikum@frametitlewidth,
                        draw=none,
                        line width=0pt,
                        inner xsep=0.3cm,
                        inner ysep=1.4ex,
                        outer sep=0pt,
                        align=flush left,
                        text depth=0em,
                    }
            }

            % Apply gradient fading if enabled
            \ifbeamer@technikum@frametitlegradient
                \tikzset{frametitle background/.append style={path fading=\beamer@technikum@frametitlegradientdirection}}
            \fi

            % Text node
            \node[frametitle node] (frametitlenode) at (0, 0) {%
                \usebeamerfont{frametitle}%
                \usebeamercolor[fg]{frametitle}%
                \insertframetitle%
            };

            % Background node (drawn behind text)
            \begin{scope}[on background layer]
                \path[frametitle background] let \p1=(frametitlenode.south west) in (0,0) rectangle (\paperwidth, \y1);
            \end{scope}

            % Add logo if enabled
            \ifbeamer@technikum@frametitlelogo
                \node[
                    anchor=north east,
                    inner sep=0pt,
                    outer sep=0pt
                ] at (\dimexpr\paperwidth-0.3cm\relax, -5pt) {%
                    \usebox{\beamer@technikum@logobox}%
                };
            \fi

            % Add subtitle if it exists
            \ifx\insertframesubtitle\@empty\else
                % Define base style for framesubtitle node
                \tikzset{
                    framesubtitle node/.style={
                            anchor=north west,
                            text width=\dimexpr\paperwidth-0.6cm\relax,
                            draw=none,
                            inner xsep=0.3cm,
                            outer sep=0pt,
                            align=flush left,
                            fill=framesubtitle.bg,
                        }
                }

                % Apply specific styles for gradient vs solid
                \ifbeamer@technikum@framesubtitlegradient
                    \tikzset{framesubtitle node/.append style={
                                inner ysep=1.4ex,
                                text depth=0em,
                                path fading=\beamer@technikum@framesubtitlegradientdirection
                            }}
                    \def\subtitleyoffset{0pt}
                \else
                    \tikzset{framesubtitle node/.append style={
                                inner ysep=0ex,
                                text depth=0.7ex
                            }}
                    \def\subtitleyoffset{1pt}
                \fi

                \path let \p1 = (current bounding box.south) in
                node[framesubtitle node] at (0, {\y1+\subtitleyoffset}) {%
                        \usebeamerfont{framesubtitle}%
                        \usebeamercolor[fg]{framesubtitle}%
                        \insertframesubtitle%
                    };
            \fi

            % Optional separator line below frametitle/subtitle
            \ifbeamer@technikum@frametitlerule
                \usebeamercolor{frametitle rule}
                % Draw at bottom of current bounding box
                \ifbeamer@technikum@frametitlerulegradient
                    % Use gradient fade for frametitle rule
                    \fill[frametitle rule.fg, path fading=\beamer@technikum@frametitlerulegradientdirection]
                    let \p1 = (current bounding box.south west),
                    \p2 = (current bounding box.south east) in
                    ({\x1+\beamer@technikum@frametitlerulemargin}, \y1)
                    rectangle
                    ({\x2-\beamer@technikum@frametitlerulemargin}, {\y1+\beamer@technikum@frametitlerulewidth});
                \else
                    % Solid color for frametitle rule
                    \draw[color=frametitle rule.fg, line width=\beamer@technikum@frametitlerulewidth]
                    let \p1 = (current bounding box.south west),
                    \p2 = (current bounding box.south east) in
                    ({\x1+\beamer@technikum@frametitlerulemargin+0.5\beamer@technikum@frametitlerulewidth}, \y1)
                    -- ({\x2-\beamer@technikum@frametitlerulemargin-0.5\beamer@technikum@frametitlerulewidth}, \y2);
                \fi
            \fi
        \end{tikzpicture}%
        \vskip4pt plus 1pt minus 2pt%
    }
\fi

% =============================================================================
% FOOTLINE
% =============================================================================
\ifbeamer@technikum@footline
    \setbeamertemplate{footline}{%
        \ifnum\value{framenumber}>0% Only show if not title page
            \ifbeamer@inappendix\else% Don't show in appendix
                \begin{tikzpicture}
                    % Get colors from beamer color scheme
                    \usebeamercolor{footline background}%
                    \usebeamercolor{footline rule}%
                    \usebeamercolor{author in head/foot}%
                    \usebeamercolor{title in head/foot}%
                    \usebeamercolor{page number in head/foot}%

                    % Define styles
                    \tikzset{
                        footline background/.style={
                                fill=footline background.bg,
                                draw=none,
                            },
                        footline node/.style={
                                inner xsep=0pt,
                                inner ysep=4pt,
                                outer sep=0pt,
                                text height=1.5ex,
                                text depth=0.5ex,
                            }
                    }

                    % Apply gradient fading if enabled
                    \ifbeamer@technikum@footlinegradient
                        \tikzset{footline background/.append style={path fading=\beamer@technikum@footlinegradientdirection}}
                    \fi

                    % Content Nodes
                    % Author (Left)
                    \node[footline node, anchor=south west, align=left, text width=0.3333\dimexpr\paperwidth-2em\relax] (author) at (1em, 0) {%
                        \usebeamerfont{author in head/foot}%
                        \usebeamercolor[fg]{author in head/foot}%
                        \copyright~\insertshortauthor%
                    };

                    % Title (Center)
                    \node[footline node, anchor=south, align=center, text width=0.3333\dimexpr\paperwidth-2em\relax] (title) at (0.5\paperwidth, 0) {%
                        \usebeamerfont{title in head/foot}%
                        \usebeamercolor[fg]{title in head/foot}%
                        \insertshorttitle%
                    };

                    % Page Number (Right)
                    \node[footline node, anchor=south east, align=right] (page) at (\dimexpr\paperwidth-1em\relax, 0) {%
                        \ifbeamer@technikum@footlinepagenumber
                            \usebeamerfont{page number in head/foot}%
                            \usebeamercolor[fg]{page number in head/foot}%
                            \insertframenumber\,/\,\inserttotalframenumber%
                        \fi
                    };

                    % Background node (drawn behind text)
                    \begin{scope}[on background layer]
                        \node[footline background, fit=(author)(title)(page), inner sep=0pt, minimum width=\paperwidth] {};
                    \end{scope}

                    % Separator line at top of footline
                    \ifbeamer@technikum@footlinerule
                        \usebeamercolor{footline rule}
                        \ifbeamer@technikum@footlinerulegradient
                            % Use gradient fade for footline rule
                            \fill[footline rule.fg, path fading=\beamer@technikum@footlinerulegradientdirection]
                            let \p1 = (current bounding box.north west),
                            \p2 = (current bounding box.north east) in
                            ({\x1+\beamer@technikum@footlinerulemargin}, \y1)
                            rectangle
                            ({\x2-\beamer@technikum@footlinerulemargin}, {\y1+\beamer@technikum@footlinerulewidth});
                        \else
                            % Solid color for footline rule
                            \draw[color=footline rule.fg, line width=\beamer@technikum@footlinerulewidth]
                            let \p1 = (current bounding box.north west),
                            \p2 = (current bounding box.north east) in
                            ({\x1+\beamer@technikum@footlinerulemargin+0.5\beamer@technikum@footlinerulewidth}, \y1)
                            -- ({\x2-\beamer@technikum@footlinerulemargin-0.5\beamer@technikum@footlinerulewidth}, \y2);
                        \fi
                    \fi
                \end{tikzpicture}%
            \fi%
        \fi%
    }
\fi

\mode<all>
